---
title: "Vaccines"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vaccines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this tutorial, we will explore how to model different strategies for both pre-erythrocytic malaria vaccines and a theoretical malaria transmission blocking vaccine (TBV). Parameters for the pre-erythrocytic vaccine can be set for a routine Expanded Programme on Immunization (EPI) strategy or a mass vaccination strategy using the helper functions `set_rtss_epi()` and `set_mass_rtss()`, while parameters for a TBV can be set using `set_tbv()`. Under an EPI strategy, everybody within a certain age range will be vaccinated within the routine immunisation system. A mass vaccination strategy is typically a one-time event where everybody, or everybody within a certain age group, is targeted for vaccination during a relatively short window of time. If you are modelling a seasonal setting, then it is also possible to schedule vaccination relative to the expected peak of malaria prevalence given by `peak_season_offset()`.

```{r setup, message=FALSE}
library(malariasimulation)

cols <- c("#E69F00", "#56B4E9", "#009E73", 
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

### Plotting functions

First, we will define a few functions to visualise the outputs.

```{r}
# Plotting clinical incidence 
plot_inci <- function(type = 'not seasonal'){
  if(type == 'seasonal'){
    comparison <- output_seas_control
    vaccinetime <- round(year + (peak - month * 3.5), 0) / 365
  } else {
    comparison <- output_control
    vaccinetime <- 1
  }
  output$clinical_incidence <- 1000 * output$n_inc_0_1825 / output$n_0_1825
  output$time_year <- output$timestep / year
  comparison$clinical_incidence <- 1000 * comparison$n_inc_0_1825 / comparison$n_0_1825
  comparison$time_year <- comparison$timestep / year

  plot(x = output$time_year, y = output$clinical_incidence, 
       type = 'l', col = cols[2],
       xlab = 'Time (years)', ylab = 'Clinical incidence (per 1000 children aged 0-5)',
       xaxs = "i", yaxs = "i", bty = "l", xaxs = "i", yaxs = "i")
  grid(lty = 2, col = 'grey80', lwd = 1)
  abline(v = vaccinetime, col = 'black', lty = 2, lwd = 2.5)
  curve_values <- loess(clinical_incidence ~ time_year, data = output, span = 0.3, method = 'loess') 
  lines(output$time_year, predict(curve_values),
        col = cols[5], lwd = 3)
  curve_valuescomp <- loess(clinical_incidence ~ time_year, data = comparison, span = 0.3, method = 'loess') 
  lines(comparison$time_year, predict(curve_valuescomp), 
        col = cols[6], lwd = 3)
  legend('topright', box.lty = 0, legend = c('Start of vaccination', 'Incidence for vaccine scenario', 'Smoothed incidence for \nno intervention scenario'),
         col = c('black', cols[5], cols[5]), lty = c(2,1,1), lwd = 2.5)
}

# Plot parasite prevalence
plot_prev <- function(type = 'not seasonal'){
    if(type == 'seasonal'){
    comparison <- output_seas_control
    vaccinetime <- round(year + (peak - month * 3.5), 0) / 365
  } else {
    comparison <- output_control
    vaccinetime <- 1
  }
  output$time_year <- output$timestep / year
  comparison$time_year <- comparison$timestep / year

  plot(x = output$time_year, y = output$n_detect_730_3650/output$n_730_3650, 
       type = 'l', col = cols[3], ylim=c(0,1),
       xlab = 'Time (years)', ylab = expression(paste(italic(Pf),"PR"[2-10])),
       xaxs = "i", yaxs = "i", bty = "l", xaxs = "i", yaxs = "i")
  grid(lty = 2, col = 'grey80', lwd = 1)
  lines(x = comparison$time_year, y = comparison$n_detect_730_3650/comparison$n_730_3650,
        col = cols[6])
  abline(v = vaccinetime, col = 'black', lty = 2, lwd = 2.5)
  legend('topright', box.lty = 0, legend = c('Start of vaccination', 'Prevalence for vaccine scenario', 'Prevalence for no intervention scenario'),
         col = c('black', cols[3], cols[6]), lty = c(2,1,1), lwd = 2.5)
}

# Plot dose timing
plot_doses <- function(){
  output$month <- ceiling(output$timestep / month)
  doses <- output[,c(2:5,38)]
  doses <- aggregate(cbind(doses[1:4]),
                      by = list(doses$month), 
                      FUN = sum)
  doses <- as.matrix(t(doses[,-1]))
  
  barplot(doses, xlab = "Month",
          ylab = 'Number of doses',
        col = cols[1:6],space = 0, 
        beside = FALSE, xaxs = "i", yaxs = "i")
  grid(lty = 2, col = 'grey80', lwd = 1)
  axis(side = 1, lty = 1, col = "black", pos = 0); axis(side = 2, lty = 1, col = "black")
  legend('topleft', box.lty = 0, legend = c('Dose 1','Dose 2','Dose 3','Booster 1'),
         col = cols[1:6], lty = rep(1, 4), lwd = 2.5, bg="transparent")
}
```

## Parameterisation

We will set the default parameters to run the simulation from an equilibrium starting point that has no seasonality using the `set_equilibrium()` function.

```{r}
year <- 365
month <- 30
sim_length <- 3 * year
human_population <- 10000
starting_EIR <- 20

simparams <- get_parameters(list(
    human_population = human_population,
    incidence_rendering_min_ages = 0,
    incidence_rendering_max_ages = 5 * year,
    individual_mosquitoes = FALSE
  )
)

simparams <- set_equilibrium(simparams, starting_EIR)

# Run a model with no interventions in a setting with no seasonality
output_control <- run_simulation(sim_length * 2, simparams)
```

Then we can run the simulation for a variety of vaccination strategies.

## Mass RTS,S

First, we will model a single round of RTS,S vaccine given in a mass vaccination strategy where those within a given age range will be vaccinated to a specified coverage level and during a short window of time. In this example, individuals aged between 5 months and 10 years are vaccinated with a primary series (3 doses) followed by a single booster 12 months after the initial vaccination. The age groups to be vaccinated as well as timing of all vaccinations can be modified within the `set_mass_rtss()` function.

We specify that the intervention should use the RTS,S vaccine through the `profile` and `booster_profile` inputs.

```{r}
rtssparams <- set_mass_rtss(
  simparams,
  timesteps = 1 * year, # The single round of vaccination is at 1 year into the simulation.
  coverages = 1, # The vaccine is given to 100% of the population between the specified ages.
  min_wait = 0, # The minimum acceptable time since the last vaccination is 0.
  min_ages = 5 * month, # The minimum age for the target population to be vaccinated. 
  max_ages = 10 * year, # The maximum age for the target population to be vaccinated.
  boosters = 12 * month, # The booster is given at 12 months after the initial vaccination. 
  booster_coverage = 0.95 # Coverage of the booster dose is 95%.
)

output <- run_simulation(sim_length, rtssparams)
```

#### Plot clinical incidence and prevalence

```{r, fig.width = 8, fig.height = 4, fig.align = 'center'}
par(mfrow = c(1,2))
plot_inci()
plot_prev()
```
We see a much more gradual decrease in clinical incidence following EPI implementation compared to the mass vaccination strategy.  
  
#### Plot doses

You can look at the distribution of doses using the `n_rtss_mass_dose_*` or `n_rtss_epi_dose_*` outputs. It is always a good idea to check the timing of vaccine doses to ensure that it is specified as intended.

```{r, fig.width = 6, fig.height = 4, fig.align = 'center', message=FALSE}
plot_doses()
```

### Seasonal mass vaccination

Mass vaccination can also be targeted seasonally. For example, we may want to have a mass vaccination campaign a few months prior to the peak transmission season. In the example below, we will create a parameter set with seasonality and first run a simulation with no vaccine, then run a simulation with a mass vaccination campaign targeting everyone between the ages of 5 months and 15 years.

We specify that the intervention should use the RTS,S vaccine through the `profile` and `booster_profile` inputs.

```{r}
# Use the get_parameters() function to generate a new parameter set with a seasonal profile with malaria incidence in children aged 0-5 rendered in the model output:
seas_simparams <- get_parameters(
	list(
    	human_population = human_population,
    	incidence_rendering_min_ages = 0,
    	incidence_rendering_max_ages = 5 * year,
    	individual_mosquitoes = FALSE,
    	model_seasonality = TRUE, # Let's try a bi-modal model
    	g0 = 0.285505,
    	g = c(-0.325352,-0.0109352,0.0779865),
    	h = c(-0.132815,0.104675,-0.013919)
  )
)

seas_simparams <- set_equilibrium(seas_simparams, starting_EIR)

# Run no vaccine scenario
output_seas_control <- run_simulation(sim_length *2, seas_simparams)
```

Next, we will run the scenario with a seasonal mass vaccination campaign implemented starting 3.5 months before the peak of the transmission season.
```{r}
# Find the peak seasonality
peak <- peak_season_offset(seas_simparams)

seasmass_simparams <- set_mass_rtss(
  parameters = seas_simparams,
  timesteps = round(year + (peak - month * 3.5), 0),# The vaccination will begin 3.5 months prior to the peak seasonality in the second year.
  coverages = 1, # 100% of the population between min_ages and max_ages is vaccinated.
  min_ages = 5 * month, #
  max_ages = 15 * year,
  min_wait = 0, # There is no minimum wait between the last vaccination.
  boosters = round(c(12 * month + 2 * month)), # The booster is given 14 months after the first dose. 
  booster_coverage = 1) # 100% of the vaccinated population is boosted.

output <- run_simulation(sim_length * 2, seasmass_simparams)
```

#### Plot clinical incidence

```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_inci(type = 'seasonal')
```

#### Plot prevalence
```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_prev(type = 'seasonal')
```

#### Plot doses

```{r, fig.width = 6, fig.height = 4, fig.align = 'center', message=FALSE}
plot_doses()
```


## RTS,S EPI

We can also opt to vaccinate using the EPI strategy, where individuals will be vaccinated once they reach a certain age. In the example below, individuals will be vaccinated once they reach 5 months of age. For this intervention, we see a much more gradual impact following implementation.

```{r}
# Add RTS,S strategy
rtssepiparams <- set_rtss_epi(
  simparams,
  timesteps = 1 * year, # Vaccination will begin at 1 year.
  coverages = 1, # Vaccine coverage is 100%.
  min_wait = 0, # There is no minimum wait since the last vaccination.
  age = 5 * month, # Individuals will be vaccinated once they reach 5 months of age.
  boosters = 12 * month, # The booster is administered 12 months following the initial vaccination. 
  booster_coverage = 0.95 # 95% of those vaccinated with the primary series will be boosted.
)

output <- run_simulation(sim_length * 2, rtssepiparams)
```

#### Plot clinical incidence

```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_inci()
```

#### Plot prevalence
```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_prev()
```

#### Plot doses

```{r, fig.width = 6, fig.height = 4, fig.align = 'center', message=FALSE}
plot_doses()
```

### RTS,S seasonal boosters

In a seasonal setting, we can set booster timesteps relative to the start of the year instead of relative to the last dose. This allows us to consider seasonal dynamics and implement booster doses right before the start of the high transmission season to maximize impact.

```{r}
# Calculate the peak of the transmission season based on seasonality parameters above.
peak <- peak_season_offset(seas_simparams) 

# Add RTS,S seasonal strategy
rtssepiseasonalparams <- set_rtss_epi(
  seas_simparams,
  timesteps = 1 * year, # Vaccination begins 1 year after the start of the simulation. 
  coverages = 1, # Vaccine coverage is 100%.
  min_wait = 6 * month, # When seasonal_boosters = TRUE, this is the minimum time between an individual receiving the final dose and the first booster.
  age = 5 * month, # Individuals will be vaccinated once they reach 5 months of age.
  boosters = peak - month * 3.5 , # Because seasonal_boosters = TRUE, the timestep here is relative to the start of the year. Here, we will give a booster at 3.5 months prior to peak transmission. 
  booster_coverage = c(.7), # 70% of the vaccinated population is boosted.
  seasonal_boosters = TRUE
)

output <- run_simulation(sim_length * 2, rtssepiseasonalparams)
```

#### Plot clinical incidence

```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_inci(type = 'seasonal')
```

#### Plot prevalence
```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_prev(type = 'seasonal')
```

#### Plot doses

```{r, fig.width = 6, fig.height = 4, fig.align = 'center', message=FALSE}
plot_doses()
```

### RTS,S dosing

You can try different dosing schedules using the `pev_doses` parameter. Here we administer dose 1 at 5 months, dose 2 30 days after dose 1, and dose 3 60 days after dose 1. We also administer two  booster doses 12 and 24 months following dose 3. As before, it is a good idea to visualise the timing of the vaccination strategy to ensure that you have implemented it as intended.

```{r}
rtssepiparams2 <- set_rtss_epi(
  simparams,
  timesteps = 1 * year,
  coverages = 1,
  age = 5 * month,
  min_wait = 0,
  boosters = c(12 * month, 24 * month), # Here, we are testing a strategy with 2 boosters.
  booster_coverage = c(1, 1)
)

rtssepiparams2$rtss_doses <- c(0, 30, 60) # setting the timesteps for the 3 doses in the primary series at 0, 1, 2 months

output <- run_simulation(sim_length * 2, rtssepiparams2)
```

#### Plot clinical incidence

```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_inci()
```

#### Plot prevalence
```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_prev()
```

#### Plot doses

```{r, fig.width = 6, fig.height = 4, fig.align = 'center', message=FALSE}
output$month <- ceiling(output$timestep / month)
doses <- output[,c(2:6,39)]
doses <- aggregate(cbind(doses[1:5]),
                    by = list(doses$month), 
                    FUN = sum)
doses <- as.matrix(t(doses[,-1]))

barplot(doses, xlab = "Month",
        ylab = 'Number of doses',
      col = cols[1:6],space = 0, 
      beside = FALSE, xaxs = "i", yaxs = "i")
grid(lty = 2, col = 'grey80', lwd = 1)
axis(side = 1, lty = 1, col = "black", pos = 0); axis(side = 2, lty = 1, col = "black")
legend('topleft', box.lty = 0, legend = c('Dose 1','Dose 2','Dose 3','Booster 1', 'Booster 2'),
       col = cols[1:6], lty = rep(1, 4), lwd = 2.5,bg="transparent")
```

## TBV

We can also model vaccines with completely different modes of actions. For example, a transmission blocking vaccine (TBV). This example shows 5 rounds of a TBV to 99% of the population aged 5 and 60.

```{r}
tbvparams <- set_tbv(
  simparams, 
  timesteps = round(c(1, 1.25, 1.5, 1.75, 2) * 365), # The TBV will be given at year 1, year 2, and every 3 months in between.
  coverages = rep(0.99, 5), # 99% of the population will be covered.
  ages = 5:60 # The age range in years of those receiving the vaccine. 
)

output <- run_simulation(sim_length, tbvparams)
```

#### Plot clinical incidence

```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_inci()
```

#### Plot prevalence
```{r, fig.width = 6, fig.height = 4 fig.align = 'center'}
plot_prev()
```

---
title: "Variation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Variation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(malariasimulation)
```

`malariasimulation` is a stochastic, individual-based model and, as such, simulations run with identical parameterisations will generate non-identical, sometimes highly variable, outputs. To illustrate this, we will compare the prevalence of malaria over a year in simulations with a small and a larger population, where a smaller population is more likely to have wide variations between simulation runs. 

### Plotting functions
First, we will create a few plotting functions to visualise outputs. 
```{r}
cols <- c("#E69F00", "#56B4E9", "#009E73", 
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
          
plot_n_detect <- function(output, ylab=TRUE){
  if (ylab==TRUE) {
    ylab = "Cases detected in children aged 2-10 years"
    } else {ylab=''}
  plot(x = output$timestep, y = output$n_detect_730_3650, 
       type = 'l', col = cols[3],
       xlab = 'Time (days)', ylab = ylab,
       xaxs = "i", yaxs = "i", bty = "l")
  grid(lty = 2, col = 'grey80', lwd = 1)
}
```

## Parameterisation
First, we will use the `get_parameters()` function to generate a list of parameters, accepting the default values, for two different population sizes. Then we will update the parameters to match equilibrium parameters and to achieve the initial EIR using `set_equilibrium()`
```{r}
# A small population 
simparams <- get_parameters(list(
  human_population = 100,
  individual_mosquitoes = FALSE
))

simparams <- set_equilibrium(simparams, init_EIR = 20)

# A larger population 
simparams <- get_parameters(list(
  human_population = 10000,
  individual_mosquitoes = FALSE
))

simparams <- set_equilibrium(simparams, init_EIR = 20)
```


## Simulations

The `n_detect_730_3650` output below shows the total number of individuals in the age group rendered (here, 730-3650 timesteps or 2-10 years) who have microscopy-detectable malaria. Notice that the output is smoother at a higher population.

```{r, fig.align='center',fig.height=4, fig.width=10}
# A small population
output_small_pop <- run_simulation(365, simparams)

# A larger population
output_big_pop <- run_simulation(365, simparams)

# Plotting 
par(mfrow = c(1,2))
plot_n_detect(output_small_pop); title('n_detect at n = 100')
plot_n_detect(output_big_pop, ylab = FALSE); title('n_detect at n = 10,000')
```

## Estimating variation 

We can estimate the variation in the number of detectable cases by repeating the simulation several times with the function `run_simulation_with_repetitions()`, then plotting the IQR and 95% confidence intervals. Running multiple simulations is particularly important for simulations of a small population size, due to the disproportionate impact of stochasticity in small populations. 

```{r, fig.align='center',fig.height=4, fig.width=10}
outputs <- run_simulation_with_repetitions(
  timesteps = 365, # We will run each simulation for 365 timesteps.
  repetitions = 10, # The simulation will be run 10 times
  overrides = simparams, # using the parameter list with the larger population that we created earlier.
  parallel = TRUE # The runs will be done in parallel.
)

# Calculate IQR and 95% confidence intervals for each of the repetitions
output <- aggregate(
  outputs$n_detect_730_3650,
  by = list(outputs$timestep),
  FUN = function(x) {
    c(
      median = median(x),
      lowq = unname(quantile(x, probs = .25)),
      highq = unname(quantile(x, probs = .75)),
      mean = mean(x),
      lowci = mean(x) + 1.96*sd(x),
      highci = mean(x) - 1.96*sd(x)
    )
  }
)

output <- data.frame(cbind(timestep = output$Group.1, output$x))

# Plot the IQR and 95% CI
par(mfrow = c(1,2))
xx <- c(output$timestep, rev(output$timestep))
yy <- c(output$lowq, rev(output$highq))
plot(x = output$timestep, y = output$median, 
       type = 'n', xlim = c(-1,365),ylim = c(1400,1700),
       xlab = 'Time (days)', ylab = "Cases detected in children aged 2-10 years",
       xaxs = "i", yaxs = "i", bty = "l")
polygon(xx, yy,
        col = 'grey90', border= 'grey95')
lines(x = output$timestep, y = output$median, col = cols[3], lwd = 2)
grid(lty = 2, col = 'grey80', lwd = 1)
title('IQR spread')
legend('bottomleft', legend = c('Median','IQR Spread'), col = c(cols[3],'grey90'),
       lwd = 5, xpd = TRUE, horiz = TRUE, cex = 1, seg.len=1, bty = 'n')

xx <- c(output$timestep, rev(output$timestep))
yy <- c(output$lowci, rev(output$highci))
plot(x = output$timestep, y = output$mean, 
       type = 'n', xlim = c(-1,365),ylim = c(1400,1700),
       xlab = 'Time (days)', ylab = "",
       xaxs = "i", yaxs = "i", bty = "l")
polygon(xx, yy,
        col = 'grey90', border= 'grey95')
lines(x = output$timestep, y = output$mean, col = cols[3], lwd = 2)
grid(lty = 2, col = 'grey80', lwd = 1)
title('95% Confidence interval')
legend('bottomleft', inset = 0, legend = c('Mean','95% CI'), col = c(cols[3],'grey90'),
       lwd = 5, xpd = TRUE, horiz = TRUE, cex = 1, seg.len=1, bty = 'n')
```



##  Estimating variation in parameters

Default parameters for the malariasimulation model were obtained from the joint posterior of MCMC fitting.

```{r plot parasite prevalence with default model parameters}

simparams <- get_parameters(list(
  human_population = 100,
  individual_mosquitoes = FALSE
))

# obtain 50 random draws from the model parameter posterior distribution

# Default (mdedian) model parameters
sim <- run_simulation(timesteps= 1000, simparams)

# plot the default median parameter
plot(sim$timestep, sim$n_detect_730_3650 / sim$n_730_3650, t = "l", ylim = c(0, 1), ylab = "PfPr", xlab = "Time in days")

```

If needed, we can estimate the variation in model parameters using the draws from this joint posterior using `set_parameter_draw`. This function will override the default model parameters with a sample from one of 1000 draws from the joint posterior.

Keep in mind that `set_parameter_draw` must be called prior to `set_equilibrium`, as the model must be calibrated to new model parameters.

```{r  run simulation on different samples of the joint posterior distribution}

# Default (mdedian) model parameters
sim <- run_simulation(timesteps= 1000, simparams)

# plot the default median parameter
plot(sim$timestep, sim$n_detect_730_3650 / sim$n_730_3650, t = "l", ylim = c(0, 1), ylab = "PfPr", xlab = "Time in days")

cols<- rainbow(50)
for (i in 1:50){

message(paste0('obtaining parameter draw ', i))
param_draw<- simparams |>
             set_parameter_draw(sample(1:1000, 1)) |>
             set_equilibrium(init_EIR= 5) 

sim<- run_simulation(timesteps= 1000, param_draw)

lines(sim$timestep, sim$n_detect_730_3650 / sim$n_730_3650, col = cols[i])

}

```

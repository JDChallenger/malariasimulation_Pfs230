---
title: "Variation"
output: html_document
vignette: >
  %\VignetteIndexEntry{Variation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(malariasimulation)
```

First we will create a few plotting functions to visualise outputs. 
```{r}
cols <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
          
plot_n_detect <- function(output){
  plot(x = output$timestep, y = output$n_detect_730_3650, 
       type = 'l', col = cols[4],
       xlab = 'Time (days)', ylab = "Cases detected in children aged 2-10 years",
       xaxs = "i", yaxs = "i", bty = "l")
}

plot_p_detect <- function(output){
  plot(x = output$timestep, y = output$p_detect_730_3650, 
       type = 'l', col = cols[4],
       xlab = 'Time (days)', ylab = "Sum of probabilities of case detection in children aged 2-10 years",
       xaxs = "i", yaxs = "i", bty = "l")
}
```
## Variation in outputs

Malariasimulation is a stochastic model, so there will be be variation in model outputs. To illustrate this, we could compare the prevalence of malaria cases over a year in simulations with a small and a larger population.

```{r}
# A small population
params <- get_parameters(list(
  human_population = 1000,
  individual_mosquitoes = FALSE
))
params <- set_equilibrium(params, 2)
small_pop <- run_simulation(365, params)

# A larger population
params <- get_parameters(list(
  human_population = 10000,
  individual_mosquitoes = FALSE
))
params <- set_equilibrium(params, 2)
big_pop <- run_simulation(365, params)

par(mfrow = c(2,2))
plot_n_detect(small_pop)
title('n_detect at n = 1,000')
plot_p_detect(small_pop)
title('p_detect at n = 1,000')
plot_n_detect(big_pop)
title('n_detect at n = 10,000')
plot_p_detect(big_pop)
title('p_detect at n = 10,000')
```

The n_detect output shows the result of sampling individuals who would be detected by microscopy.

While the p_detect output shows the sum of probabilities of detection in the population.

Notice that the p_detect output is slightly smoother. That's because it forgoes the sampling step. At low population sizes, p_detect will be smoother than the n_detect counterpart.

## Estimating variation 

We can estimate the variation in the number of detectable cases by repeating the simulation several times and plotting the IQR and 95% confidence intervals. 

```{r}
outputs <- run_simulation_with_repetitions(
  timesteps = 365,
  repetitions = 10,
  overrides = params,
  parallel=TRUE
)

# Calculate IQR and 95% confidence intervals for each of the repetitions
df <- aggregate(
  outputs$n_detect_730_3650,
  by = list(outputs$timestep),
  FUN = function(x) {
    c(
      median = median(x),
      lowq = unname(quantile(x, probs = .25)),
      highq = unname(quantile(x, probs = .75)),
      mean = mean(x),
      lowci = mean(x) + 1.96*sd(x),
      highci = mean(x) - 1.96*sd(x)
    )
  }
)

df <- data.frame(cbind(timestep = df$Group.1, df$x))

par(mfrow = c(1,2))
xx <- c(df$timestep, rev(df$timestep))
yy <- c(df$lowq, rev(df$highq))
plot(x = df$timestep, y = df$median, 
       type = 'n', xlim = c(-1,365),ylim = c(510,565),
       xlab = 'Time (days)', ylab = "Cases detected in children aged 2-10 years",
       xaxs = "i", yaxs = "i", bty = "l")
polygon(xx, yy,
        col = 'grey90', border= 'grey95')
lines(x = df$timestep, y = df$median, col = cols[4], lwd = 2)
title('IQR spread')

xx <- c(df$timestep, rev(df$timestep))
yy <- c(df$lowci, rev(df$highci))
plot(x = df$timestep, y = df$mean, 
       type = 'n', xlim = c(-1,365),ylim = c(490,590),
       xlab = 'Time (days)', ylab = "Cases detected in children aged 2-10 years",
       xaxs = "i", yaxs = "i", bty = "l")
polygon(xx, yy,
        col = 'grey90', border= 'grey95')
lines(x = df$timestep, y = df$mean, col = cols[4], lwd = 2)
title('95% Confidence interval')
```

These are useful techniques for comparing the expected variance from model outputs to outcomes from trials that had lower population sizes.
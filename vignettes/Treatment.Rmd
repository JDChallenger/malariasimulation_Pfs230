---
title: "Treatment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Treatment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(malariasimulation)
library(malariaEquilibrium)
```

Set up some baseline parameters:

```{r}
year <- 365
sim_length <- 2 * year
human_population <- 1000

simparams <- get_parameters(list(human_population = human_population))
simparams <- set_drugs(simparams, list(AL_params, DHA_PQP_params))
```

Run the model for some starting EIRs and fts:

```{r}
outputs <- list()
starting_EIR <- 10
fts <- c(0, .25, .5, .75, 1.)

for (ft in fts) {
  simparams <- set_clinical_treatment(simparams, 1, 1, ft / 2)
  simparams <- set_clinical_treatment(simparams, 2, 1, ft / 2)
  simparams <- set_equilibrium(simparams, starting_EIR)
  output <- run_simulation(sim_length, simparams)
  # cut out the warmup
  output <- output[output$timestep > year,]
  outputs[[length(outputs) + 1]] <- output
}
```

Let's plot the effect of ft on PfPR2-10:

```{r}
df <- do.call('rbind', lapply(seq_along(outputs), function(i) {
  df <- outputs[[i]][c('timestep', 'n_detect_730_3650', 'n_730_3650')]
  df$ft <- fts[[i]]
  df
}))
    
colorBlindBlack8  <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

Treatment_plot_function <- function(df){
    par(fig=c(0,0.9,0,1), cex = 0.8, mai = c(0.8,0.8,0.3,0.1))
  with(df[df$ft==unique(df$ft)[1],], expr = plot(x = timestep, y = n_detect_730_3650/n_730_3650, type = "l",
                                                 xlab = "Days", ylab = expression(paste(italic(Pf),"PR"[2-10])),
                                                 ylim = c(min(df$n_detect_730_3650/df$n_730_3650),max(df$n_detect_730_3650/df$n_730_3650)), col = colorBlindBlack8[1]))
  invisible(sapply(2:length(unique(df$ft)), function(x){
    with(df[df$ft==unique(df$ft)[x],], expr = points(x = timestep, y = n_detect_730_3650/n_730_3650, type = "l", col = colorBlindBlack8[x]))
}))
  par(fig=c(0.9,1,0,1), cex = 0.8, new = T, xpd = T, mai = c(0,0,0,0))
  legend("right", legend = unique(df$ft), col = colorBlindBlack8, bty = "n", lty = 1, title = "Coverage")
}

Treatment_plot_function(df)
```

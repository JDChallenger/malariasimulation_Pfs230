---
title: "Treatment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Treatment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(malariasimulation)
library(malariaEquilibrium)
```

# Introduction

This vignette describes how to implement clinical drug treatments in malariasimulation.

The malariasimulation package contains in-built parameters sets for three anti-malarial drugs:

1.  AL_params: artemether-lumefantrine
2.  DHA_PQP_params: dihydroartemisinin and piperaquine
3.  SP_AQ: sulfadoxine-pyrimethamine and amodiaquine

which can be included using the `set_drugs()` function. Multiple drugs can be used simultaneously, input as a list as shown in the below example.

Each drug parameter set is a vector of length four, that represent the `drug efficacy`, ***drug_rel_c***, ***drug_prophylaxis_shape***, and ***drug_prophylaxis_scale***. ***I don't fully know the impact of changing these parameters, or what they mean exactly, e.g. rel_c is relative concentration? prophylaxis_shape? Scale? What does that look like*** \

For example:

```{r}
AL_params
```

Drug parameters can be incorporated into a complete parameter set:

```{r}
Intro_parms <- set_drugs(parameters = get_parameters(), drugs = AL_params)
```

A treatment regiment for each drug can then be described using the `set_clinical_treatment()` function which takes the drug index, a vector of timesteps for each change in coverage and a vector of coverages for the drug, as well as the complete parameter set. This function must be used for each drug included (e.g., if there are two drugs, `set_clinical_treatment()` must be called twice).

```{r}
Intro_parms <- set_clinical_treatment(parameters = Intro_parms, drug = 1,
                                      timesteps = c(10,15,20), coverages = c(0.2,0.5,1))
```

\

# Example

## Parameterisation

Set up some initial parameters:

```{r}
# Daily simulation timesteps for two years
year <- 365
sim_length <- 2 * year

# With a population size of 1000
human_population <- 1000
simparams <- get_parameters(list(human_population = human_population))
```

Update parameter set with chosen drug-specific parameters:

```{r}
# Incorporate drug parameters (AL and DHA/PQP) into complete parameter set
simparams <- set_drugs(simparams, list(AL_params, DHA_PQP_params))

```

\

## Simulation

This simulation will be run for 2 years for different drug coverage programs:

```{r}
outputs <- list() # Create an empty list for results
starting_EIR <- 10 # Set initial EIR to 10

# We will vary coverage values between 0 and 0.5
covs <- seq(0, 0.5, by = 0.1) 

# Iterate over coverage values
for (cov in covs) {
  
  # Set treatment programs for each drug (1 and 2), starting on day 1: 
  simparams <- set_clinical_treatment(simparams, 1, 1, cov) # Set treatment program for AL
  simparams <- set_clinical_treatment(simparams, 2, 1, cov) # Set treatment program for DHA/PQP
  
  # Use set_equilibrium to update the parameter set for a given initial EIR
  simparams2 <- set_equilibrium(simparams, starting_EIR) 
  
  # Run simulation:
  output <- run_simulation(sim_length, simparams)
  # remove the first year (which can be considered a warmup)
  output <- output[output$timestep > year,]
  # Add output to outputs list
  outputs[[length(outputs) + 1]] <- output 
}
```

\

## Visualisation

We will plot the effect of drug treatment coverage on *Pf*PR~2-10~ through time using the n_detect_730_3650 and n_730_3650 outputs.

```{r}
Rich_cols  <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# Join listed results into a single data frame
df <- do.call('rbind', lapply(seq_along(outputs), function(i) {
  
  # Select variables of interest
  df <- outputs[[i]][c('timestep', 'n_detect_730_3650', 'n_730_3650')]

  # Create a new variable for Pf Prevalence
  df$PfPR2_10 <- df$n_detect_730_3650/df$n_730_3650
  
  # Attach coverage value
  df$coverage <- covs[[i]] 
  
  # return results
  df
}))
    
Treatment_plot_function <- function(df){
  
  # Set figure margins and sections
  par(fig=c(0,0.9,0,1), cex = 0.8, mai = c(0.8,0.8,0.3,0.1))
  
  # Create initial plot with first set of results
  with(df[df$coverage==unique(df$coverage)[1],],
       expr = plot(x = timestep, y = PfPR2_10, type = "l",
                   xlab = "Days", ylab = expression(paste(italic(Pf),"PR"[2-10])),
                   ylim = c(min(df$PfPR2_10),max(df$PfPR2_10)), col = Rich_cols[1]))
  
  # Add remaining results
  invisible(sapply(2:length(unique(df$coverage)), function(x){
    with(df[df$coverage==unique(df$coverage)[x],],
         expr = points(x = timestep, y = PfPR2_10, type = "l",col = Rich_cols[x]))
}))
  
  # Add figure legend
  par(fig=c(0.9,1,0,1), cex = 0.8, new = T, xpd = T, mai = c(0,0,0,0))
  legend("right", legend = paste0(100*unique(df$coverage),"%"),
         col = Rich_cols, bty = "n", lty = 1, title = "Coverage")
}

Treatment_plot_function(df)
```
